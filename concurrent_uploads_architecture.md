# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫ –≤ Google Sheets

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏ —Ñ–∞–π–ª–æ–≤** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Google Sheets.

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Telegram Bot  ‚îÇ    ‚îÇ  File Monitor    ‚îÇ    ‚îÇ Google Sheets   ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                  ‚îÇ    ‚îÇ   Service       ‚îÇ
‚îÇ ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∫–∞     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ       ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ ‚Ä¢ –ó–∞–≥—Ä—É–∑–∫–∞      ‚îÇ
‚îÇ   callback      ‚îÇ    ‚îÇ   –º–∞—Ä–∫–µ—Ä–æ–≤       ‚îÇ    ‚îÇ   –¥–∞–Ω–Ω—ã—Ö        ‚îÇ
‚îÇ   –∑–∞–ø—Ä–æ—Å–æ–≤      ‚îÇ    ‚îÇ ‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ   ‚îÇ    ‚îÇ ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ      ‚îÇ
‚îÇ ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ      ‚îÇ    ‚îÇ   —Å–æ—Å—Ç–æ—è–Ω–∏—è      ‚îÇ    ‚îÇ   –ª–∏—Å—Ç–æ–≤        ‚îÇ
‚îÇ   –∫–Ω–æ–ø–æ–∫        ‚îÇ    ‚îÇ ‚Ä¢ –û—á–∏—Å—Ç–∫–∞        ‚îÇ    ‚îÇ ‚Ä¢ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ (–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç:
‚îú‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ "üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ Google Sheets" –¥–ª—è file1.csv
‚îú‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ "üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ Google Sheets" –¥–ª—è file2.csv
‚îî‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ "üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ Google Sheets" –¥–ª—è file3.csv
```

### 2. Telegram Bot –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback –∑–∞–ø—Ä–æ—Å—ã

```python
async def handle_callback_query(self, callback_query):
    # –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
    if query_data.startswith("upload_csv:"):
        filename = query_data.split(":", 1)[1]
        await self._handle_upload_csv_request(query_id, filename)
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ —Ñ–∞–π–ª–æ–≤ (–∞—Ç–æ–º–∞—Ä–Ω–æ)

```python
async def _handle_upload_csv_request(self, query_id: str, filename: str):
    # –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ —Ñ–∞–π–ª–∞
    marker_filename = f".upload_me_{filename}"
    marker_path = self.reports_dir / marker_filename

    with open(marker_path, "w", encoding="utf-8") as f:
        f.write(f"Upload request for {filename}\n")
        f.write(f"Created at: {datetime.now().isoformat()}\n")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
reports/
‚îú‚îÄ‚îÄ file1.csv
‚îú‚îÄ‚îÄ file2.csv
‚îú‚îÄ‚îÄ file3.csv
‚îú‚îÄ‚îÄ .upload_me_file1.csv  ‚Üê –ú–∞—Ä–∫–µ—Ä –¥–ª—è file1.csv
‚îú‚îÄ‚îÄ .upload_me_file2.csv  ‚Üê –ú–∞—Ä–∫–µ—Ä –¥–ª—è file2.csv
‚îî‚îÄ‚îÄ .upload_me_file3.csv  ‚Üê –ú–∞—Ä–∫–µ—Ä –¥–ª—è file3.csv
```

### 4. –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏

```python
def start_monitoring(self):
    while True:
        # –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏
        files_with_markers = self.file_monitor.get_files_with_upload_markers()

        for filename in files_with_markers:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞
            success = self.process_single_file(file_path)
            if success:
                # –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
                self.file_monitor.remove_upload_marker(filename)
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ:

1. **–ê—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤**
   - –ö–∞–∂–¥—ã–π –º–∞—Ä–∫–µ—Ä —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ
   - –ù–µ—Ç race conditions –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
   - –§–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –û–°

2. **–ù–µ–∑–∞–≤–∏—Å–∏–º–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤**
   - –ö–∞–∂–¥—ã–π callback –∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
   - –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
   - –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—É—á–∞—é—Ç –æ—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞

3. **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤**
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–µ —Å–æ–∑–¥–∞—é—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
   - –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –º–∞—Ä–∫–µ—Ä
   - –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Google Sheets API**
   - Rate limiting (100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 100 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   - –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã
   - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏

2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏–º–µ–Ω –ª–∏—Å—Ç–æ–≤**
   - –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∏–º–µ–Ω–∞
   - Google Sheets –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ª–∏—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—É—Ñ—Ñ–∏–∫—Å—ã

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### 1. –î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏

```python
class UploadQueue:
    def __init__(self):
        self.queue = asyncio.Queue()
        self.processing = set()

    async def add_upload_request(self, filename: str):
        await self.queue.put(filename)

    async def process_queue(self):
        while True:
            filename = await self.queue.get()
            if filename not in self.processing:
                self.processing.add(filename)
                await self.process_file(filename)
                self.processing.remove(filename)
```

### 2. –î–æ–±–∞–≤–∏—Ç—å rate limiting

```python
import time

class RateLimiter:
    def __init__(self, max_requests=90, time_window=100):
        self.max_requests = max_requests
        self.time_window = time_window
        self.requests = []

    async def wait_if_needed(self):
        now = time.time()
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã
        self.requests = [req_time for req_time in self.requests
                        if now - req_time < self.time_window]

        if len(self.requests) >= self.max_requests:
            sleep_time = self.time_window - (now - self.requests[0])
            await asyncio.sleep(sleep_time)

        self.requests.append(now)
```

### 3. –î–æ–±–∞–≤–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –ª–∏—Å—Ç–æ–≤

```python
def _generate_unique_sheet_name(self, filename: str) -> str:
    base_name = self._sanitize_sheet_name(filename)
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    return f"{base_name}_{timestamp}"
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ **–±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** –±–ª–∞–≥–æ–¥–∞—Ä—è:

- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
- –ê—Ç–æ–º–∞—Ä–Ω—ã–º –æ–ø–µ—Ä–∞—Ü–∏—è–º —Å —Ñ–∞–π–ª–∞–º–∏
- –ù–µ–∑–∞–≤–∏—Å–∏–º–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- –°–∏—Å—Ç–µ–º–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets API.
