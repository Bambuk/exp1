# Status Change Report Generator

Команда для генерации отчёта о количестве смен статусов задач в разрезе авторов за последние 2 недели.

## Описание

Команда `GenerateStatusChangeReportCommand` анализирует данные из таблиц `tracker_tasks` и `tracker_task_history` для создания отчёта о том, сколько раз каждый автор менял статусы задач за последние две недели.

## Возможности

- **Анализ по неделям**: Разделение данных на прошедшую неделю и позапрошлую
- **Группировка по авторам**: Подсчёт смен статусов для каждого автора задач
- **CSV экспорт**: Сохранение отчёта в CSV формате для дальнейшего анализа
- **Визуализация**: Генерация таблицы для наглядного представления данных
- **Консольный вывод**: Красивый отчёт в консоли с итоговой статистикой

## Структура отчёта

Отчёт содержит следующие данные для каждого автора:
- **Last Week**: Количество смен статусов за прошедшую неделю
- **Week Before Last**: Количество смен статусов за позапрошлую неделю

## Использование

### Запуск через PowerShell скрипт

```powershell
.\generate_status_report.ps1
```

### Запуск через Python модуль

```bash
python -m radiator.commands.generate_status_change_report
```

### Запуск с пользовательскими именами файлов

```bash
python -m radiator.commands.generate_status_change_report --csv my_report.csv --table my_table.png
```

### Демонстрационная версия (без подключения к БД)

Если у вас есть проблемы с подключением к базе данных, вы можете использовать демонстрационную версию:

```powershell
.\generate_demo_report.ps1
```

```bash
python -m radiator.commands.generate_status_change_report_demo
```

### Программное использование

```python
from radiator.commands.generate_status_change_report import GenerateStatusChangeReportCommand

with GenerateStatusChangeReportCommand() as cmd:
    success = cmd.run()
    if success:
        print("Отчёт сгенерирован успешно!")
```

## Выходные файлы

### CSV файл
Файл содержит таблицу с данными по каждому автору:
```csv
Author,Last Week,Week Before Last
user1,5,2
user2,3,0
user3,0,4
```

### PNG таблица
Таблица, показывающая:
- Зелёный заголовок с названиями колонок
- Чередующиеся цвета строк для удобства чтения
- Центрированное выравнивание всех данных
- Чёткая структура: Автор, Прошедшая неделя, Позапрошлая неделя

## Логика работы

1. **Расчёт периодов**: Автоматически определяет границы недель относительно текущей даты
2. **Запрос к БД**: Выполняет JOIN между таблицами задач и истории статусов
3. **Фильтрация**: Учитывает только записи с указанным автором и в заданном временном диапазоне
4. **Агрегация**: Подсчитывает количество смен статусов для каждого автора
5. **Формирование отчёта**: Объединяет данные по неделям и вычисляет общие суммы

## Требования

- Python 3.8+
- matplotlib >= 3.7.0
- Доступ к базе данных PostgreSQL
- Таблицы `tracker_tasks` и `tracker_task_history` должны существовать

## Переменные окружения

- `DATABASE_URL_SYNC`: URL подключения к базе данных

## Обработка ошибок

Команда корректно обрабатывает следующие ситуации:
- Отсутствие данных за указанный период
- Ошибки подключения к базе данных
- Проблемы с созданием файлов
- Ошибки генерации диаграммы

## Тестирование

Запуск тестов:
```bash
pytest tests/test_generate_status_change_report.py -v
```

Тесты покрывают:
- Инициализацию команды
- Работу с базой данных
- Генерацию CSV отчётов
- Создание диаграмм
- Обработку ошибок
- Интеграционные сценарии

## Примеры использования

### Еженедельный отчёт
```bash
# Каждый понедельник
python -m radiator.commands.generate_status_change_report
```

### Отчёт с пользовательскими именами
```bash
python -m radiator.commands.generate_status_change_report \
    --csv weekly_status_report.csv \
    --chart weekly_status_chart.png
```

### Автоматизация через cron
```bash
# Каждый понедельник в 9:00
0 9 * * 1 cd /path/to/project && python -m radiator.commands.generate_status_change_report
```

## Структура кода

```
radiator/commands/
├── generate_status_change_report.py         # Основная команда
├── generate_status_change_report_demo.py    # Демонстрационная версия
├── __init__.py
└── ...

tests/
├── test_generate_status_change_report.py    # Тесты команды
└── ...

generate_status_report.ps1                   # PowerShell скрипт для запуска
generate_demo_report.ps1                     # PowerShell скрипт для демо версии
```

## Решение проблем

### Проблемы с кодировкой UTF-8

Если вы получаете ошибки кодировки при подключении к базе данных:
```
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xc2 in position 61
```

Это может быть связано с:
- Неправильными настройками кодировки в базе данных
- Специальными символами в именах авторов
- Проблемами с драйвером PostgreSQL

**Решения:**
1. Используйте демонстрационную версию для тестирования функциональности
2. Проверьте настройки кодировки в PostgreSQL
3. Добавьте параметр `client_encoding=utf8` в строку подключения
4. Обратитесь к администратору базы данных

### Проблемы с подключением к БД

Если команда не может подключиться к базе данных:
1. Проверьте переменные окружения `DATABASE_URL_SYNC`
2. Убедитесь, что PostgreSQL запущен
3. Проверьте права доступа пользователя
4. Используйте демонстрационную версию для тестирования

## Расширение функциональности

Команда легко расширяется для:
- Анализа за другие временные периоды
- Добавления дополнительных метрик
- Экспорта в другие форматы
- Интеграции с системами уведомлений
- Создания различных типов диаграмм
