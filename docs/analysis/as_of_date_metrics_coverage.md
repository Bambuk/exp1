# Анализ поддержки as-of-date для всех метрик TTM Details

Дата: 2026-02-06

## Цель

Проверить, какие метрики в отчете TTM Details корректно учитывают параметр `as_of_date` при расчете для незавершенных задач.

## Методология

Созданы комплексные тесты (`tests/test_all_metrics_as_of_date.py`), которые проверяют каждую метрику:
1. Создается задача с открытым интервалом (незавершенная)
2. Метрика рассчитывается с двумя разными `as_of_date` (разница 10+ дней)
3. Проверяется, что значение метрики изменяется соответственно

## Результаты тестирования

### ✅ Метрики, корректно поддерживающие as-of-date (2/8)

| Метрика | Метод | Статус | Комментарий |
|---------|-------|--------|-------------|
| **DevLT** | `MetricsService.calculate_dev_lead_time()` | ✅ **PASSED** | Исправлено в рамках фикса от 2026-02-06 |
| **TTM (unfinished)** | `TTMDetailsReportGenerator._calculate_ttm_unfinished()` | ✅ **PASSED** | Работает корректно |
| **Pause** | `MetricsService.calculate_pause_time_up_to_date()` | ✅ **PASSED** | Уже принимает `end_date` параметр |

### ❌ Метрики, НЕ поддерживающие as-of-date (6/8)

| Метрика | Метод | Ошибка | Необходимые изменения |
|---------|-------|--------|----------------------|
| **Tail** | `TTMDetailsReportGenerator._calculate_tail()` | TypeError | Не принимает `as_of_date` параметр |
| **TTD** | `TTMDetailsReportGenerator._calculate_ttd()` | TypeError | Не принимает `as_of_date` параметр |
| **Discovery backlog (дни)** | `TTMDetailsReportGenerator._calculate_discovery_backlog_days()` | TypeError | Не принимает `as_of_date` параметр |
| **Готова к разработке (дни)** | `TTMDetailsReportGenerator._calculate_ready_for_dev_days()` | TypeError | Не принимает `as_of_date` параметр |
| **TTD Pause** | `TTMDetailsReportGenerator._calculate_ttd_pause()` | TypeError | Не принимает `as_of_date` параметр |
| **Status Duration (generic)** | `MetricsService.calculate_status_duration()` | TypeError | Не принимает `as_of_date` параметр |

## Детальный анализ проблемных метрик

### 1. Tail (Хвост)

**Проблема:** Для задач, находящихся в статусе "МП / Внешний тест" или последующих статусах с открытым интервалом, tail не учитывает `as_of_date`.

**Влияние:** Tail для таких задач всегда рассчитывается до текущей даты, делая исторические отчеты некорректными.

**Решение:** Добавить параметр `as_of_date` в `_calculate_tail()` и пробросить его в `MetricsService.calculate_tail_metric()`.

### 2. TTD (Time To Delivery)

**Проблема:** Для задач со статусом "Готова к разработке" с открытым интервалом, TTD не учитывает `as_of_date`.

**Влияние:** TTD включает время до текущей даты вместо исторической, искажая данные в as-of-date отчетах.

**Решение:** Добавить параметр `as_of_date` в `_calculate_ttd()` и пробросить его в `MetricsService.calculate_time_to_delivery()`.

### 3. Discovery backlog (дни)

**Проблема:** Для задач, находящихся в "Discovery backlog" с открытым интервалом, длительность не учитывает `as_of_date`.

**Влияние:** Количество дней в Discovery backlog всегда рассчитывается до текущей даты.

**Решение:** Добавить параметр `as_of_date` в `_calculate_discovery_backlog_days()` и использовать его для расчета открытых интервалов.

### 4. Готова к разработке (дни)

**Проблема:** Аналогично Discovery backlog - не учитывается `as_of_date` для открытых интервалов.

**Решение:** Добавить параметр `as_of_date` в `_calculate_ready_for_dev_days()` и использовать его для расчета открытых интервалов.

### 5. TTD Pause

**Проблема:** Пауза в фазе Discovery/TTD с открытым интервалом не учитывает `as_of_date`.

**Влияние:** TTD Pause для задач в активной паузе всегда включает время до текущей даты.

**Решение:** Добавить параметр `as_of_date` в `_calculate_ttd_pause()` и пробросить его в расчеты паузы.

### 6. calculate_status_duration (generic helper)

**Проблема:** Базовый метод для расчета времени в статусе не принимает `as_of_date`.

**Влияние:** Все методы, использующие `calculate_status_duration` для открытых интервалов, не могут корректно учитывать историческую дату.

**Решение:** Добавить параметр `as_of_date: Optional[datetime] = None` в `MetricsService.calculate_status_duration()` и использовать его вместо `datetime.now()` для открытых интервалов.

## Приоритизация исправлений

### Высокий приоритет

1. **calculate_status_duration** - базовый метод, от которого зависят другие
2. **Discovery backlog (дни)** и **Готова к разработке (дни)** - часто имеют открытые интервалы
3. **TTD** - важная метрика для понимания времени до готовности к разработке

### Средний приоритет

4. **Tail** - влияет на задачи в testing/release фазах
5. **TTD Pause** - важно для задач с длительными паузами в Discovery

## Рекомендации

1. **Применить TDD подход**: Тесты уже созданы и падают - нужно только исправить код
2. **Постепенное внедрение**: Исправлять метрики в порядке приоритета
3. **Регрессионное тестирование**: После каждого исправления запускать полный набор тестов
4. **Документирование**: Обновить `docs/guides/TTM_DETAILS_REPORT_GUIDE.md` после завершения

## Статус

- [x] DevLT - исправлено ✅
- [x] TTM (unfinished) - работает ✅
- [x] Pause - работает ✅
- [ ] calculate_status_duration - требует исправления
- [ ] Discovery backlog - требует исправления
- [ ] Готова к разработке - требует исправления
- [ ] TTD - требует исправления
- [ ] Tail - требует исправления
- [ ] TTD Pause - требует исправления

**Прогресс: 3/9 метрик поддерживают as-of-date (33%)**

## Тестовый файл

Все тесты находятся в `/home/vm/dev/radiator/tests/test_all_metrics_as_of_date.py`

Запуск:
```bash
pytest tests/test_all_metrics_as_of_date.py -v
```

## Влияние на отчеты

При сравнении отчетов месяц к месяцу обнаружено:
- **DevLT** теперь корректно изменяется для незавершенных задач ✅
- Другие метрики могут показывать одинаковые значения для исторических отчетов, если задачи имеют открытые интервалы в соответствующих статусах

### Пример: команда "Корзинка и заказ"

Все метрики остались неизменными в сравнении месяц к месяцу, потому что:
- Задачи закрыли фазу разработки до исторической даты (DevLT зафиксирован) ✅
- Задачи сейчас находятся в фазах после разработки
- Tail для этих задач должен был изменитьсz, но не изменился - это **баг** ❌
