# Database Snapshots

Система для создания и восстановления снапшотов баз данных PostgreSQL.

## Обзор

Система позволяет создавать полные дампы продакшен (`radiator`) и тестовой (`radiator_test`) баз данных, а также восстанавливать их из снапшотов. Каждый снапшот хранится в отдельной папке с временной меткой.

## Структура хранения

```
.snapshots/
  └── snapshot_2025-10-15_14-30-45/
      ├── radiator.sql          # дамп продакшен БД
      ├── radiator_test.sql     # дамп тестовой БД
      └── metadata.json         # информация о снапшоте
```

## Команды

### Создание снапшотов

```bash
# Создать снапшот обеих баз данных
make db-snapshot

# Создать снапшот только продакшен БД
make db-snapshot-prod

# Создать снапшот только тестовой БД
make db-snapshot-test
```

### Восстановление

```bash
# Интерактивное восстановление (выбор снапшота)
make db-restore

# Показать список всех снапшотов
make db-list-snapshots
```

### Прямое использование скриптов

```bash
# Создание снапшота
python3 scripts/database/snapshot_db.py [--prod-only|--test-only]

# Восстановление
python3 scripts/database/restore_db.py [--snapshot NAME] [--prod-only|--test-only] [--force]

# Список снапшотов
python3 scripts/database/restore_db.py --list
```

## Примеры использования

### Создание снапшота перед важными изменениями

```bash
# Создать снапшот обеих БД
make db-snapshot

# Выполнить миграции или другие изменения
make migrate

# При необходимости восстановить из снапшота
make db-restore
```

### Создание снапшота только продакшен БД

```bash
make db-snapshot-prod
```

### Восстановление конкретного снапшота

```bash
# Сначала посмотреть доступные снапшоты
make db-list-snapshots

# Восстановить конкретный снапшот
python3 scripts/database/restore_db.py --snapshot snapshot_2025-10-15_14-30-45 --force
```

## Метаданные снапшота

Каждый снапшот содержит файл `metadata.json` с информацией:

```json
{
  "timestamp": "2025-10-15T14:30:45",
  "databases": {
    "radiator": {
      "size_mb": 125.5,
      "tables_count": 15,
      "dump_file": "radiator.sql"
    },
    "radiator_test": {
      "size_mb": 0.5,
      "tables_count": 15,
      "dump_file": "radiator_test.sql"
    }
  }
}
```

## Безопасность

- Снапшоты хранятся в папке `.snapshots/` и коммитятся в репозиторий
- При восстановлении происходит полная замена БД (все данные теряются)
- Требуется подтверждение операции (можно пропустить через `--force`)
- Снапшоты содержат полные дампы БД - будьте осторожны с конфиденциальными данными

## Требования

- PostgreSQL с установленными `pg_dump` и `psql`
- Доступ к базам данных `radiator` и `radiator_test`
- Настроенные переменные окружения в `.env` файлах

## Устранение неполадок

### Ошибка подключения к БД

Проверьте настройки в `.env` файлах:
- `DATABASE_URL_SYNC` для продакшен БД
- Настройки для тестовой БД

### Ошибка прав доступа

Убедитесь, что пользователь БД имеет права на:
- Создание и удаление баз данных
- Создание дампов
- Восстановление из дампов

### Большой размер снапшотов

Снапшоты могут занимать много места в репозитории. Рекомендации:

1. **Создавайте снапшоты только при необходимости** (перед важными изменениями)
2. **Удаляйте старые снапшоты** после успешного применения изменений:
   ```bash
   # Удалить старые снапшоты
   rm -rf .snapshots/snapshot_2025-10-01_*
   git add .snapshots/
   git commit -m "Remove old database snapshots"
   ```
3. **Используйте .gitattributes** для сжатия SQL файлов:
   ```bash
   echo "*.sql filter=lfs diff=lfs merge=lfs -text" >> .gitattributes
   ```
