# Инструкция по использованию отчёта Time To Delivery и Time To Market

## Описание

Команда `generate_time_to_market_report` генерирует отчёт о времени выполнения CPO задач по авторам и командам за определённые периоды. Отчёт показывает метрики Time To Delivery и Time To Market с расчётом среднего значения и 85% перцентиля.

## Что показывает отчёт

### Метрики

#### Time To Delivery
- **Определение**: Количество дней от создания задачи до перехода в статус "Готова к разработке"
- **Целевой статус**: Статус "Готова к разработке" (первый переход)
- **Расчёт**: `(дата "Готова к разработке" - дата создания) - время_пауз_до_целевого_статуса`

#### Time To Market
- **Определение**: Количество дней от создания задачи до завершения (перехода в статус из блока `done`)
- **Целевые статусы**: Все статусы из блока `done` (согласно `data/config/status_order.txt`)
- **Расчёт**: `(дата done-статуса - дата создания) - время_пауз_до_целевого_статуса`

#### Обработка пауз
- **Статус паузы**: "Приостановлено"
- **Учет пауз**: Только до достижения целевого статуса
- **Исключение**: Паузы после целевого статуса не учитываются в расчете

### Периоды анализа

Периоды загружаются из файла `data/config/quarters.txt` в формате:
```
<Название периода>;<Дата начала>;<Дата окончания>
```

Пример:
```
2025.Q1;2025-01-27;2025-04-20
2025.Q2;2025-04-21;2025-07-20
2025.Q3;2025-07-21;2025-10-12
```

**Важно**:
- **TTD**: К периоду задача относится по дате перехода в статус "Готова к разработке"
- **TTM**: К периоду задача относится по дате перехода в любой done-статус
- Задача может попадать в разные кварталы для TTD и TTM метрик
- Задача не может попадать в несколько кварталов для одной и той же метрики

### Статистика

Для каждой метрики рассчитывается:
- **Среднее значение** - среднее арифметическое времени выполнения
- **85% перцентиль** - значение, ниже которого находится 85% всех измерений

### Группировка

Отчёт поддерживает группировку по:
- **Авторам** (`--group-by author`) - по полю `author` из задач
- **Командам** (`--group-by team`) - по полю `team` из задач

## Фильтрация данных

### Включаемые задачи
- Только CPO задачи (ключ начинается с `CPO-`)
- Задачи с указанным автором/командой (не NULL)
- Задачи, достигшие целевых статусов в указанном периоде

### Исключаемые задачи
- Задачи без завершения (не достигшие целевых статусов)
- Отмененные задачи (статус "Отменено" не считается завершенным)
- Задачи без автора/команды
- Не-CPO задачи

## Выходные данные

### CSV файл
Содержит детальную информацию по каждому автору/команде:
- Название автора/команды
- Период
- Количество задач в анализе
- Time To Delivery: среднее, 85% перцентиль
- Time To Market: среднее, 85% перцентиль
- **Discovery backlog (дни)**: время в статусе "Discovery backlog" (новое в v2.1)
- **Готова к разработке (дни)**: время в статусе "Готова к разработке" (новое в v2.1)

### Табличный файл (PNG)
Визуальная таблица с основными метриками для быстрого просмотра.

## Способы запуска

### 1. Через Python модуль
```bash
# Запуск с настройками по умолчанию (группировка по авторам)
python -m radiator.commands.generate_time_to_market_report

# Группировка по командам
python -m radiator.commands.generate_time_to_market_report --group-by team

# С указанием имён файлов
python -m radiator.commands.generate_time_to_market_report --csv my_report.csv --table my_table.png
```

### 2. Через CLI
```bash
# Группировка по авторам
radiator generate-time-to-market-report

# Группировка по командам
radiator generate-time-to-market-report --group-by team

# С указанием файлов
radiator generate-time-to-market-report --csv data/reports/time_to_market.csv --table data/reports/time_to_market.png

# С длинным форматом CSV
radiator generate-time-to-market-report --csv-format long
```

### 3. Через Makefile
```bash
# Генерация отчёта по авторам (широкий формат)
make generate-time-to-market-report

# Генерация отчёта по авторам (длинный формат)
make generate-time-to-market-report-long

# Генерация отчёта по командам (широкий формат)
make generate-time-to-market-report-teams

# Генерация отчёта по командам (длинный формат)
make generate-time-to-market-report-teams-long
```

## Параметры команды

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `--group-by` | Группировка: `author` или `team` | `author` |
| `--csv` | Путь к CSV файлу отчёта | `data/reports/time_to_market_report_{timestamp}.csv` |
| `--table` | Путь к PNG файлу таблицы | `data/reports/time_to_market_table_{timestamp}.png` |
| `--csv-format` | Формат CSV: `wide` (кварталы в колонках) или `long` (кварталы в строках) | `wide` |
| `--report-type` | Тип отчёта: `ttd`, `ttm` или `both` | `both` |

## Структура выходных файлов

### CSV файл

#### Формат Wide (по умолчанию)
В широком формате кварталы представлены как отдельные колонки:
```csv
group_name,Q1 2024_ttd_mean,Q1 2024_ttd_p85,Q1 2024_ttd_tasks,Q2 2024_ttd_mean,Q2 2024_ttd_p85,Q2 2024_ttd_tasks,...
Иван Иванов,12.4,18.0,5,10.2,15.3,7,...
Петр Петров,8.7,12.0,3,9.5,13.8,4,...
```

**Преимущества:**
- Компактный формат для небольшого количества кварталов
- Удобен для визуального анализа в Excel
- Легко сравнивать метрики между кварталами

#### Формат Long (длинный)
В длинном формате квартал представлен как отдельная колонка:
```csv
group_name,quarter,ttd_mean,ttd_p85,ttd_tasks,ttm_mean,ttm_p85,ttm_tasks,...
Иван Иванов,Q1 2024,12.4,18.0,5,45.2,67.0,5,...
Иван Иванов,Q2 2024,10.2,15.3,7,42.1,61.3,7,...
Петр Петров,Q1 2024,8.7,12.0,3,38.1,55.0,3,...
Петр Петров,Q2 2024,9.5,13.8,4,40.2,58.5,4,...
```

**Преимущества:**
- Удобен для анализа большого количества кварталов
- Легко импортировать в аналитические инструменты (pandas, SQL)
- Проще для построения графиков и pivot-таблиц
- Более читаем при большом количестве периодов

**Для выбора формата используйте параметр `--csv-format`:**
```bash
# Широкий формат (по умолчанию)
python -m radiator.commands.generate_time_to_market_report --csv-format wide

# Длинный формат
python -m radiator.commands.generate_time_to_market_report --csv-format long
```

### Табличный файл
Визуальная таблица с колонками:
- Автор/Команда
- Период
- Задач
- TTD (среднее)
- TTD (85%)
- TTM (среднее)
- TTM (85%)

## Логика расчёта

### Определение дат
1. **Дата создания**: `TrackerTask.created_at`
2. **Дата перехода в статус**: `TrackerTaskHistory.start_date` для соответствующего статуса

### Алгоритм расчёта
1. Загрузить все CPO задачи с авторами/командами
2. Для каждой задачи найти историю статусов
3. Определить даты перехода в целевые статусы
4. Отфильтровать задачи по периоду (по дате перехода в целевой статус)
5. Рассчитать время выполнения в днях
6. Сгруппировать по авторам/командам
7. Рассчитать статистику (среднее, 85% перцентиль)

### Обработка граничных случаев
- **Задачи без истории статусов**: Исключаются из анализа
- **Задачи с несколькими переходами в целевой статус**: Берётся первый переход
- **Задачи без целевых статусов**: Исключаются из анализа
- **Некорректные даты**: Исключаются из анализа с логированием

## Конфигурация

### Файл периодов
Отредактируйте файл `data/config/quarters.txt` для настройки анализируемых периодов.

### Маппинг статусов
Отредактируйте файл `data/config/status_order.txt` для настройки блоков статусов:

- **`discovery`** - статусы для TTD (включая "Готова к разработке")
- **`done`** - статусы для TTM (завершенные задачи: "Done", "Закрыт", "Выполнено с ИТ", и т.д.)
- **`cancelled`** - отмененные задачи (НЕ участвуют в расчете метрик)
- **`pause`** - статусы паузы ("Приостановлено")

**Важно:** Статус "Отменено" имеет блок `cancelled` и не включается в расчет TTM/TTD.

## Примеры использования

### Анализ производительности авторов за квартал
```bash
python -m radiator.commands.generate_time_to_market_report --group-by author
```

### Сравнение команд
```bash
python -m radiator.commands.generate_time_to_market_report --group-by team
```

### Генерация отчёта для презентации
```bash
python -m radiator.commands.generate_time_to_market_report --csv data/reports/q1_2025_metrics.csv --table data/reports/q1_2025_table.png
```

## Интерпретация результатов

### Time To Delivery
- **Низкие значения** (5-10 дней): Быстрый переход к разработке
- **Высокие значения** (20+ дней): Длительный период анализа и планирования

### Time To Market
- **Низкие значения** (30-60 дней): Быстрая доставка в продукт
- **Высокие значения** (90+ дней): Длительный цикл разработки

### 85% перцентиль
Показывает, что 85% задач выполняются быстрее указанного времени. Полезен для планирования и установки реалистичных ожиданий.

### Новые метрики времени в статусах (v2.1)

#### Discovery backlog (дни)
- **Низкие значения** (1-3 дня): Быстрое планирование и приоритизация
- **Высокие значения** (10+ дней): Проблемы с планированием или перегрузка backlog

#### Готова к разработке (дни)
- **Низкие значения** (1-2 дня): Быстрая передача задач разработчикам
- **Высокие значения** (7+ дней): Задержки в передаче задач или проблемы с ресурсами

**Применение:** Эти метрики помогают выявить узкие места в процессе и оптимизировать workflow.

## Поддержка

При возникновении проблем:
1. Проверьте наличие данных в базе (запустите синхронизацию трекера)
2. Убедитесь в корректности файлов конфигурации
3. Проверьте логи приложения на наличие ошибок

## Дополнительная документация

- [TTM_TTD_CALCULATION.md](../../TTM_TTD_CALCULATION.md) - подробное техническое описание алгоритмов расчета
- [ANALYSIS_TTM_TTD_LOGIC_FLAWS.md](../../ANALYSIS_TTM_TTD_LOGIC_FLAWS.md) - анализ логических проблем
- [CHANGELOG_TTM_TTD_FIX.md](../../CHANGELOG_TTM_TTD_FIX.md) - история исправлений
