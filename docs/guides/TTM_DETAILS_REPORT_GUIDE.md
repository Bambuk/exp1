# Инструкция по использованию отчёта TTM Details

## Описание

Команда `generate_ttm_details_report` генерирует детализированный CSV отчёт о времени выполнения CPO задач с полным набором метрик. Отчёт включает информацию по каждой задаче отдельно: TTM, TTD, Tail, DevLT, паузы, время в статусах, возвраты и другие метрики.

## Использование

### Базовое использование

```bash
python -m radiator.commands.generate_ttm_details_report --output report.csv
```

### Генерация отчета на определенную дату (as-of-date)

Вы можете сгенерировать отчет "как будто" на конкретную дату в прошлом:

```bash
python -m radiator.commands.generate_ttm_details_report \
    --output report.csv \
    --as-of-date 2025-01-15
```

Эта функциональность полезна для:
- Анализа исторических данных
- Сравнения метрик в разные периоды времени
- Воспроизведения прошлых отчетов
- Отслеживания изменений метрик во времени

**Как работает as-of-date:**
- История задач фильтруется: записи с `start_date > as_of_date` отбрасываются
- Записи с `end_date > as_of_date` обрезаются (end_date устанавливается в None)
- Все метрики (TTM, TTD, DevLT и т.д.) рассчитываются на основе отфильтрованной истории
- Незавершенные задачи рассчитываются до указанной даты вместо текущей

**Формат даты:** YYYY-MM-DD (например, 2025-02-15)

**Примечание:** Все даты обрабатываются в UTC timezone.

## Что показывает отчёт

### Структура CSV файла

Отчёт содержит 23 колонки с детальной информацией по каждой задаче:

#### Базовые поля
- **Ключ задачи** - ключ задачи из трекера (например, CPO-123)
- **Название** - название задачи
- **Автор** - автор задачи
- **Команда** - команда автора (определяется через `AuthorTeamMappingService` если не указана в задаче)
- **PM Lead** - PM Lead команды (определяется через `TeamLeadMappingService`)

#### Метрики времени
- **TTM (Time To Market)** - количество дней от создания задачи до завершения (для завершенных задач) или до текущей даты (для незавершенных)
- **TTD (Time To Delivery)** - количество дней от создания задачи до перехода в статус "Готова к разработке"
- **Tail** - время от начала статуса "МП / Внешний тест" до первого done-статуса после него (с исключением пауз)
- **DevLT (Development Lead Time)** - время от первого валидного "МП / В работе" до последнего валидного "МП / Внешний тест" (календарное время, без исключения пауз). Для незавершенных задач в статусе "МП / В работе" рассчитывается до текущей даты

#### Паузы
- **Пауза** - общее время пауз в задаче
- **TTD Pause** - время пауз до достижения статуса "Готова к разработке"

#### Время в статусах
- **Discovery backlog (дни)** - время, проведенное в статусе "Discovery backlog"
- **Готова к разработке (дни)** - время, проведенное в статусе "Готова к разработке"

#### Возвраты
- **Возвраты с Testing** - количество возвратов в статус "Testing" для всех связанных FULLSTACK задач
- **Возвраты с Внешний тест** - количество возвратов в статус "Внешний тест" для всех связанных FULLSTACK задач
- **Всего возвратов** - сумма возвратов с Testing и Внешний тест

#### Даты и периоды
- **Квартал** - квартал завершения задачи (определяется по дате stable_done для завершенных задач)
- **Квартал TTD** - квартал перехода в статус "Готова к разработке"
- **Создана** - дата создания задачи
- **Начало работы** - дата последнего выхода из статуса "Discovery backlog"
- **Завершено** - дата стабильного завершения (stable_done) для завершенных задач

#### Флаги
- **Разработка** - 1 если задача имеет валидный статус "МП / В работе" (>= 5 минут), иначе 0
- **Завершена** - 1 для завершенных задач (с stable_done), 0 для незавершенных

## Логика формирования отчета

### Обработка завершенных задач

Завершенные задачи определяются наличием **stable_done** - последнего стабильного done-статуса, после которого задача не возвращалась в работу.

**Алгоритм обработки:**
1. Загружаются все CPO задачи, которые достигли done-статуса в указанном диапазоне дат (от начала первого до конца последнего квартала)
2. Для каждой задачи определяется stable_done
3. Определяется квартал по дате stable_done
4. Рассчитываются все метрики на основе истории статусов

**TTM для завершенных задач:**
- Рассчитывается от даты создания до даты stable_done
- Учитываются паузы до достижения stable_done
- Формула: `(дата stable_done - дата создания) - паузы_до_stable_done`

### Обработка незавершенных задач

Незавершенные задачи - это задачи, которые:
- Перешли в статус "Готова к разработке" (есть TTD)
- Но не имеют stable_done (не завершены)

**Алгоритм обработки:**
1. Загружаются все задачи, которые перешли в "Готова к разработке" в диапазоне от начала первого квартала до текущей даты
2. Фильтруются задачи без stable_done
3. Рассчитываются метрики на основе текущего состояния

**TTM для незавершенных задач:**
- Рассчитывается от даты создания до текущей даты
- Учитываются паузы до текущей даты
- Формула: `(текущая дата - дата создания) - паузы_до_текущей_даты`
- Квартал не определяется (поле "Квартал" остается пустым)

### Определение квартала

- **Для завершенных задач**: Квартал определяется по дате stable_done
- **Для незавершенных задач**: Квартал не определяется (поле остается пустым)

### Batch-оптимизации

Отчёт использует batch-обработку для оптимизации производительности:

1. **Batch-загрузка задач**: Все задачи загружаются одним запросом по диапазону дат вместо итерации по кварталам
2. **Batch-расчет возвратов**:
   - Сначала строится полная иерархия FULLSTACK задач для всех CPO задач
   - Затем загружаются все истории FULLSTACK задач одним batch-запросом
   - Возвраты рассчитываются в памяти без дополнительных SQL запросов
3. **Кэширование конфигурации**: Кварталы и маппинг статусов кэшируются на уровне класса

## Расчет метрик

### Time To Market (TTM)

**Для завершенных задач:**
- Целевой статус: stable_done (последний стабильный done-статус)
- Расчёт: `(дата stable_done - дата создания) - паузы_до_stable_done`

**Для незавершенных задач:**
- Целевая дата: текущая дата
- Расчёт: `(текущая дата - дата создания) - паузы_до_текущей_даты`

### Time To Delivery (TTD)

- Целевой статус: "Готова к разработке" (первый переход)
- Расчёт: `(дата "Готова к разработке" - дата создания) - паузы_до_целевого_статуса`

### Tail

- Время от начала статуса "МП / Внешний тест" до первого done-статуса после него
- Расчёт: `(дата первого done-статуса - дата начала "МП / Внешний тест") - паузы_между_этими_датами`
- Используется последний валидный статус "МП / Внешний тест" (длительность >= 5 минут)
- Показывает время от начала внешнего тестирования до завершения задачи
- Если статус "МП / Внешний тест" отсутствует, метрика не рассчитывается

### DevLT (Development Lead Time)

- Время от первого валидного статуса "МП / В работе" до последнего валидного статуса "МП / Внешний тест"
- Расчёт: `(дата начала "МП / Внешний тест" - дата начала "МП / В работе")` (календарное время, без исключения пауз)
- Для "МП / В работе": учитываются только записи с end_date и длительностью >= 5 минут
- Для "МП / Внешний тест": учитываются записи с длительностью >= 5 минут (end_date опционален)
- Если валидного "МП / Внешний тест" нет, используется первый валидный последующий статус (после "МП / Внешний тест" в status_order.txt)
- **Для незавершенных задач**: Если задача все еще находится в статусе "МП / В работе" (есть открытый интервал), то DevLT рассчитывается от даты первого входа в открытый "МП / В работе" до текущей даты (UTC): `(текущая дата UTC - дата начала открытого "МП / В работе")`
- Показывает время разработки от начала работы до начала внешнего тестирования (или до текущего момента для незавершенных задач)

### Возвраты

Возвраты рассчитываются для всех связанных FULLSTACK задач через иерархию:

1. **Поиск связанных FULLSTACK задач**: Для каждой CPO задачи находятся все связанные FULLSTACK задачи (через связи типа "relates")
2. **Построение иерархии**: Для каждого FULLSTACK эпика строится полная иерархия (эпик + все подзадачи)
3. **Подсчет возвратов**: Для каждой FULLSTACK задачи подсчитываются возвраты в статусы:
   - **"Testing"** → Возвраты с Testing
   - **"Внешний тест"** → Возвраты с Внешний тест
4. **Агрегация**: Возвраты суммируются по всем FULLSTACK задачам для каждой CPO задачи

**Формула подсчета возвратов:**
- Возврат = количество входов в статус - 1 (первый вход не считается возвратом)
- Если задача несколько раз переходила в статус "Testing", каждый переход после первого считается возвратом

**Пример:**
```
CPO-123 связана с FULLSTACK-456
FULLSTACK-456 имеет историю:
  - Testing (первый раз) - не считается возвратом
  - В работе
  - Testing (второй раз) - возврат #1
  - В работе
  - Testing (третий раз) - возврат #2
Итого: Возвраты с Testing = 2
```

## Периоды анализа

Периоды загружаются из файла `data/config/quarters.txt` в формате:
```
<Название периода>;<Дата начала>;<Дата окончания>
```

Пример:
```
2025.Q1;2025-01-27;2025-04-20
2025.Q2;2025-04-21;2025-07-20
2025.Q3;2025-07-21;2025-10-12
```

**Важно:**
- Для завершенных задач: Квартал определяется по дате stable_done
- Для незавершенных задач: Квартал не определяется
- Задача может попадать в разные кварталы для TTD (Квартал TTD) и TTM (Квартал)

## Фильтрация данных

### Включаемые задачи
- Только CPO задачи (ключ начинается с `CPO-`)
- Задачи с автором (не NULL)
- Завершенные задачи: достигшие stable_done в указанном диапазоне кварталов
- Незавершенные задачи: перешедшие в "Готова к разработке" в диапазоне от начала первого квартала до текущей даты

### Исключаемые задачи
- Отмененные задачи (статус "Отменено" не считается завершенным)
- Задачи без автора
- Не-CPO задачи
- Завершенные задачи без stable_done (нестабильные done-статусы)

## Способы запуска

### 1. Через Makefile
```bash
# Генерация details-отчета
make generate-ttm-details-report
```

### 2. Через Python модуль
```bash
python -m radiator.commands.generate_ttm_details_report --output data/reports/ttm_details.csv
```

### 3. С указанием конфигурационной директории
```bash
python -m radiator.commands.generate_ttm_details_report \
  --output data/reports/ttm_details.csv \
  --config-dir data/config
```

## Параметры команды

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `--output` | Путь к CSV файлу отчёта | Обязательный параметр |
| `--config-dir` | Путь к директории с конфигурацией | `data/config` |

## Структура выходного файла

### CSV файл

CSV файл содержит одну строку для каждой задачи со следующими колонками:

```csv
Ключ задачи,Название,Автор,Команда,PM Lead,Квартал,TTM,Пауза,Tail,DevLT,TTD,TTD Pause,Discovery backlog (дни),Готова к разработке (дни),Возвраты с Testing,Возвраты с Внешний тест,Всего возвратов,Квартал TTD,Создана,Начало работы,Завершено,Разработка,Завершена
CPO-123,Название задачи,Иван Иванов,Команда А,PM Lead 1,2025.Q1,45,2,5,10,12,1,3,6,2,1,3,2025.Q1,2025-01-15,2025-01-18,2025-03-01,1,1
CPO-456,Другая задача,Петр Петров,Команда Б,PM Lead 2,,30,,,8,10,0,2,4,0,0,0,2025.Q1,2025-02-01,2025-02-03,,1,0
```

**Примечания:**
- Пустые значения в числовых полях отображаются как пустая строка
- Для незавершенных задач поле "Квартал" и "Завершено" остаются пустыми
- Флаги "Разработка" и "Завершена" имеют значения 0 или 1

## Интерпретация результатов

### Time To Market (TTM)
- **Низкие значения** (30-60 дней): Быстрая доставка в продукт
- **Высокие значения** (90+ дней): Длительный цикл разработки
- **Для незавершенных задач**: Показывает текущий прогресс до текущей даты

### Time To Delivery (TTD)
- **Низкие значения** (5-10 дней): Быстрый переход к разработке
- **Высокие значения** (20+ дней): Длительный период анализа и планирования

### Tail
- **Низкие значения** (0-2 дня): Быстрое завершение после начала внешнего тестирования
- **Высокие значения** (10+ дней): Длительный период от начала внешнего тестирования до завершения задачи

### DevLT
- **Низкие значения** (5-10 дней): Быстрая разработка
- **Высокие значения** (30+ дней): Длительная разработка
- **Для незавершенных задач**: Если задача все еще в статусе "МП / В работе", DevLT рассчитывается до текущей даты

### Возвраты
- **Низкие значения** (0-1): Хорошее качество, минимум доработок
- **Высокие значения** (5+): Проблемы с качеством, множественные доработки

### Время в статусах

#### Discovery backlog (дни)
- **Низкие значения** (1-3 дня): Быстрое планирование и приоритизация
- **Высокие значения** (10+ дней): Проблемы с планированием или перегрузка backlog

#### Готова к разработке (дни)
- **Низкие значения** (1-2 дня): Быстрая передача задач разработчикам
- **Высокие значения** (7+ дней): Задержки в передаче задач или проблемы с ресурсами

### Флаги

#### Разработка
- **1**: Задача прошла через разработку (есть валидный статус "МП / В работе")
- **0**: Задача не дошла до разработки или разработка была слишком короткой (< 5 минут)

#### Завершена
- **1**: Задача завершена (есть stable_done)
- **0**: Задача незавершена (нет stable_done, но есть переход в "Готова к разработке")

## Конфигурация

### Файл периодов
Отредактируйте файл `data/config/quarters.txt` для настройки анализируемых периодов.

### Маппинг статусов
Отредактируйте файл `data/config/status_order.txt` для настройки блоков статусов:

- **`discovery`** - статусы для TTD (включая "Готова к разработке")
- **`done`** - статусы для TTM (завершенные задачи: "Done", "Закрыт", "Выполнено с ИТ", и т.д.)
- **`cancelled`** - отмененные задачи (НЕ участвуют в расчете метрик)
- **`pause`** - статусы паузы ("Приостановлено")

**Важно:** Статус "Отменено" имеет блок `cancelled` и не включается в расчет TTM/TTD.

### Маппинг авторов на команды
Файл `data/config/cpo_authors.txt` содержит маппинг авторов на команды:
```
<Автор>;<Команда>
```

### Маппинг команд на PM Lead
Файл `data/config/teamsleads.txt` содержит маппинг команд на PM Lead:
```
<Команда>;<PM Lead>
```

## Примеры использования

### Генерация отчёта для анализа
```bash
make generate-ttm-details-report
```

### Генерация отчёта с указанием пути
```bash
python -m radiator.commands.generate_ttm_details_report \
  --output data/reports/q1_2025_details.csv
```

### Анализ незавершенных задач
В CSV файле незавершенные задачи можно найти по фильтру:
- `Завершена = 0`
- `Квартал = ""` (пустое значение)

### Анализ задач с возвратами
В CSV файле задачи с возвратами можно найти по фильтру:
- `Всего возвратов > 0`

## Поддержка

При возникновении проблем:
1. Проверьте наличие данных в базе (запустите синхронизацию трекера)
2. Убедитесь в корректности файлов конфигурации
3. Проверьте логи приложения на наличие ошибок

## Дополнительная документация

- [TTM_TTD_CALCULATION.md](../../TTM_TTD_CALCULATION.md) - подробное техническое описание алгоритмов расчета
- [deep_optimization_results.md](../../deep_optimization_results.md) - результаты оптимизации производительности
