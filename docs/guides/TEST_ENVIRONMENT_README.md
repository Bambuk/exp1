# Тестовое окружение для Radiator

Этот документ описывает настройку и использование тестового окружения для проекта Radiator.

## Обзор

Тестовое окружение настроено таким образом, что:
- **Тесты** используют базу данных `radiator_test`
- **Основное приложение** использует базу данных `radiator`
- Переключение между окружениями происходит автоматически

## Структура баз данных

- `radiator` - основная база данных для продакшена и разработки
- `radiator_test` - тестовая база данных для запуска тестов

## Настройка тестового окружения

### 1. Создание тестовой базы данных

#### Windows (PowerShell)
```powershell
# Создать тестовую базу данных
.\create_test_db.ps1

# Удалить тестовую базу данных
.\create_test_db.ps1 -Drop
```

#### Linux/Mac (Python)
```bash
# Создать тестовую базу данных
python create_test_db.py

# Удалить тестовую базу данных
python create_test_db.py --drop
```

#### Через Makefile
```bash
# Создать тестовую базу данных
make test-db-create

# Удалить тестовую базу данных
make test-db-drop

# Сбросить тестовую базу данных (удалить и создать заново)
make test-db-reset
```

### 2. Проверка конфигурации тестового окружения

```bash
make test-env
```

Эта команда покажет:
- Текущее окружение
- URL тестовой базы данных
- Статус тестового окружения

## Запуск тестов

### Все тесты
```bash
make test
```

### Отдельные категории тестов
```bash
# Только unit тесты
make test-unit

# Только integration тесты
make test-integration

# Только tracker тесты
make test-tracker
```

### Тесты с покрытием
```bash
# Общее покрытие
make test

# Покрытие tracker модулей
make test-tracker-coverage
```

## Конфигурация

### Переменные окружения для тестов

Тесты автоматически используют следующие переменные окружения:

```ini
ENVIRONMENT=test
DATABASE_URL=postgresql+asyncpg://postgres:12345@localhost:5432/radiator_test
DATABASE_URL_SYNC=postgresql://postgres:12345@localhost:5432/radiator_test
SECRET_KEY=test-secret-key-for-testing-only
LOG_LEVEL=DEBUG
REDIS_URL=redis://localhost:6379/1
```

### Автоматическое переключение

При запуске тестов система автоматически:
1. Устанавливает `ENVIRONMENT=test`
2. Переключается на базу данных `radiator_test`
3. Использует тестовые настройки безопасности и логирования

## Структура файлов окружения

- `.env` - основное окружение (продакшен/разработка)
- `.env.test` - тестовое окружение

## Команды Makefile для тестирования

| Команда | Описание |
|---------|----------|
| `make test` | Запустить все тесты |
| `make test-unit` | Запустить только unit тесты |
| `make test-integration` | Запустить только integration тесты |
| `make test-tracker` | Запустить все tracker тесты |
| `make test-db-create` | Создать тестовую базу данных |
| `make test-db-drop` | Удалить тестовую базу данных |
| `make test-db-reset` | Сбросить тестовую базу данных |
| `make test-env` | Проверить конфигурацию тестового окружения |

## Troubleshooting

### Ошибка подключения к тестовой базе данных

1. Убедитесь, что PostgreSQL запущен
2. Проверьте, что тестовая база данных создана:
   ```bash
   make test-db-create
   ```
3. Проверьте конфигурацию:
   ```bash
   make test-env
   ```

### Тесты используют основную базу данных

1. Убедитесь, что в `pytest.ini` установлен `ENVIRONMENT=test`
2. Проверьте, что в `conftest_main.py` правильно установлены переменные окружения
3. Запустите тесты через pytest, а не напрямую через Python

### Ошибки миграций в тестах

Тесты не должны выполнять миграции основной базы данных. Если это происходит:
1. Проверьте, что `ENVIRONMENT=test` установлен до импорта приложения
2. Убедитесь, что тесты используют тестовую базу данных

## Лучшие практики

1. **Всегда используйте `make test-*` команды** для запуска тестов
2. **Регулярно сбрасывайте тестовую базу данных** для чистоты тестов
3. **Не запускайте тесты напрямую** через Python - используйте pytest
4. **Проверяйте конфигурацию** перед запуском тестов: `make test-env`
5. **Используйте отдельные базы данных** для тестов и продакшена

## Примеры использования

### Полный цикл тестирования

```bash
# 1. Создать тестовую базу данных
make test-db-create

# 2. Проверить конфигурацию
make test-env

# 3. Запустить тесты
make test

# 4. При необходимости сбросить тестовую БД
make test-db-reset
```

### Разработка с тестами

```bash
# Запустить тесты при изменении кода
make test

# Запустить только tracker тесты
make test-tracker

# Проверить покрытие кода
make test-tracker-coverage
```
