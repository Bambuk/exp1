# Инструкция по использованию отчёта FULLSTACK Sub-epic Returns

## Описание

Команда `generate_fullstack_subepic_returns_report` генерирует CSV отчёт по возвратам для подэпиков очереди FULLSTACK. Отчёт показывает количество возвратов в различные статусы для каждого подэпика, а также привязку к эпику и месяцу создания первого подэпика.

## Что показывает отчёт

### Структура CSV файла

Отчёт содержит 14 колонок с информацией по каждому подэпику:

#### Базовые поля
- **Ключ задачи** - ключ подэпика из трекера (например, FULLSTACK-123)
- **Название** - название подэпика
- **Автор** - автор подэпика
- **Команда** - продуктовая команда подэпика (из поля `prodteam` или `full_data`, при отсутствии берётся из родительского эпика)
- **Ключ эпика** - ключ родительского эпика
- **Название эпика** - название родительского эпика
- **Месяц эпика** - месяц создания первого подэпика эпика в формате `YYYY-MM` (стабильная метка времени для группировки)

#### Возвраты по статусам
- **Возвраты InProgress** - количество возвратов в статус "InProgress"
- **Возвраты Ревью** - количество возвратов в статус "Ревью"
- **Возвраты Testing** - количество возвратов в статус "Testing"
- **Возвраты Внешний тест** - количество возвратов в статус "Внешний тест"
- **Возвраты Апрув** - количество возвратов в статус "Апрув"
- **Возвраты Регресс-тест** - количество возвратов в статус "Регресс-тест"
- **Возвраты Done** - количество возвратов в статус "Done"

## Логика формирования отчета

### Определение подэпиков

Подэпик определяется по наличию связи типа "epic" с направлением "outward" в поле `links` задачи:

```json
{
  "type": {"id": "epic"},
  "direction": "outward",
  "object": {"key": "FULLSTACK-10", "display": "Epic name"}
}
```

**Критерии отбора:**
- Очередь: `FULLSTACK-*`
- Наличие связи с эпиком (тип "epic", направление "outward")
- Дата создания >= указанной стартовой даты (по умолчанию `2025-01-01`)

### Определение команды (prodteam)

Продуктовая команда определяется в следующем порядке приоритета:

1. **Из колонки `prodteam`** задачи подэпика
2. **Из `full_data`** задачи подэпика (поле `63515d47fe387b7ce7b9fc55--prodteam` для CPO или `6361307d94f52e42ae308615--prodteam` для FULLSTACK)
3. **Из родительского эпика** (аналогично: сначала колонка, затем `full_data`)

Если команда не найдена ни в подэпике, ни в эпике, поле остаётся пустым.

### Определение месяца эпика

Месяц эпика вычисляется как **минимальная дата создания** (`created_at`) среди всех подэпиков этого эпика, форматируется как `YYYY-MM`.

**Важно:**
- Все подэпики одного эпика получают **одинаковое значение** месяца
- Месяц стабилен: не меняется при повторной генерации отчёта, так как основан на неизменяемой дате создания
- Если у подэпика нет `created_at`, он не участвует в расчёте месяца для эпика

**Пример:**
```
Эпик FULLSTACK-50:
  - Подэпик FULLSTACK-51: created_at = 2025-05-15
  - Подэпик FULLSTACK-52: created_at = 2025-06-20

Результат: оба подэпика получат "Месяц эпика" = "2025-05" (min дата)
```

### Подсчёт возвратов

Возвратом считается **повторный вход** в статус. Формула: `количество входов в статус - 1` (первый вход не считается возвратом).

**Алгоритм подсчёта:**
1. История статусов задачи сортируется по дате
2. Для каждого целевого статуса подсчитываются переходы в этот статус
3. Если предыдущий статус был другим, это считается входом
4. Возвраты = количество входов - 1

**Пример:**
```
История статусов:
  - Testing (первый раз) → не считается возвратом
  - InProgress
  - Testing (второй раз) → возврат #1
  - InProgress
  - Testing (третий раз) → возврат #2

Итого: Возвраты Testing = 2
```

**Целевые статусы для подсчёта:**
- InProgress
- Ревью
- Testing
- Внешний тест
- Апрув
- Регресс-тест
- Done

### Batch-оптимизации

Отчёт использует batch-обработку для оптимизации производительности:

1. **Batch-загрузка подэпиков**: Все подэпики загружаются одним SQL-запросом с фильтрацией по очереди, наличию links и дате создания
2. **Batch-загрузка историй**: Истории статусов для всех подэпиков загружаются одним batch-запросом через `DataService.get_task_histories_by_keys_batch`
3. **Batch-загрузка prodteam эпиков**: Prodteam для всех уникальных эпиков загружаются одним запросом
4. **Вычисление месяца эпика**: Происходит в памяти после загрузки всех подэпиков

## Периоды анализа

По умолчанию отчёт включает подэпики, созданные с **2025-01-01**. Стартовую дату можно изменить через параметр `--start-date`.

**Важно:**
- Фильтрация происходит по дате создания подэпика (`created_at`)
- Месяц эпика вычисляется только среди подэпиков, попавших в выборку
- При изменении стартовой даты месяц эпика может измениться, если в выборку попадут более ранние подэпики

## Фильтрация данных

### Включаемые задачи
- Только задачи очереди FULLSTACK (ключ начинается с `FULLSTACK-`)
- Задачи с наличием связи типа "epic" (direction="outward")
- Задачи, созданные >= стартовой даты

### Исключаемые задачи
- Задачи других очередей
- Задачи без связи с эпиком
- Задачи, созданные до стартовой даты

## Способы запуска

### 1. Через Makefile
```bash
# Генерация отчёта с параметрами по умолчанию
make generate-fullstack-subepic-returns-report

# С указанием стартовой даты
make generate-fullstack-subepic-returns-report START_DATE=2025-02-01
```

### 2. Напрямую через Python
```bash
# С параметрами по умолчанию (start-date=2025-01-01, output=data/reports/fullstack_subepic_returns.csv)
python -m radiator.commands.generate_fullstack_subepic_returns_report

# С указанием параметров
python -m radiator.commands.generate_fullstack_subepic_returns_report \
    --start-date 2025-02-01 \
    --output data/reports/my_report.csv
```

### 3. Через CLI с параметрами
```bash
. venv/bin/activate
python -m radiator.commands.generate_fullstack_subepic_returns_report \
    --start-date 2025-01-01 \
    --output data/reports/fullstack_subepic_returns_2025-01.csv
```

## Параметры команды

- `--start-date` (опционально) - Дата начала отбора подэпиков в формате `YYYY-MM-DD`. По умолчанию: `2025-01-01`
- `--output` (опционально) - Путь к выходному CSV файлу. По умолчанию: `data/reports/fullstack_subepic_returns.csv`

## Пример использования

```bash
# Генерация отчёта для подэпиков, созданных с начала 2025 года
make generate-fullstack-subepic-returns-report

# Генерация отчёта с другой стартовой датой
make generate-fullstack-subepic-returns-report START_DATE=2024-12-01

# Генерация с указанием выходного файла
python -m radiator.commands.generate_fullstack_subepic_returns_report \
    --start-date 2025-01-01 \
    --output data/reports/subepic_returns_q1_2025.csv
```

## Интерпретация результатов

### Месяц эпика
- Используется для группировки подэпиков по времени создания эпика
- Все подэпики одного эпика имеют одинаковый месяц
- Стабилен при повторной генерации (не зависит от текущих статусов)

### Возвраты
- Показывают, сколько раз задача возвращалась в каждый статус
- Высокие значения возвратов могут указывать на проблемы в процессе разработки/тестирования
- Возвраты в статусы "Testing" и "Внешний тест" особенно важны для оценки качества

### Команда
- Если команда пустая, возможно, поле `prodteam` не заполнено в трекере
- При синхронизации задач через `sync-tracker` поле `prodteam` должно автоматически подтягиваться из API

## Требования

- База данных должна быть синхронизирована с Yandex Tracker (выполнен `sync-tracker`)
- В базе должны быть задачи очереди FULLSTACK с заполненными полями:
  - `links` (связи с эпиками)
  - `created_at` (дата создания)
  - `prodteam` или `full_data` (для определения команды)

## Примечания

- Отчёт генерируется только для подэпиков (задач с связью типа "epic")
- Если подэпик не имеет истории статусов, все возвраты будут равны 0
- Месяц эпика вычисляется только среди подэпиков, попавших в выборку по стартовой дате
- При изменении стартовой даты месяц эпика может измениться, если в выборку попадут более ранние подэпики
