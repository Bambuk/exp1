# Настройка маршрутизации для обхода VPN при обращении к серверам Яндекса

Этот набор скриптов позволяет настроить маршрутизацию так, чтобы запросы к серверам Яндекса (включая api.tracker.yandex.net) шли напрямую через основной интернет-канал, минуя VPN.

## Проблема

При использовании VPN все интернет-трафик проходит через VPN-сервер, что может вызывать:
- Задержки при обращении к российским сервисам
- Блокировки со стороны Яндекса
- Нестабильную работу API

## Решение

Настройка статических маршрутов для IP-адресов Яндекса, которые будут направлять трафик напрямую через основной шлюз.

## Файлы

- `setup_yandex_routes_manual.sh` - Показывает команды для ручной настройки
- `setup_yandex_routes.sh` - Автоматический скрипт настройки (требует sudo)
- `install_yandex_routes.sh` - Скрипт для установки systemd сервиса
- `yandex-routes.service` - Systemd сервис для автоматического применения маршрутов

## Быстрая настройка

### Вариант 1: Ручная настройка (рекомендуется для тестирования)

```bash
# Запустите скрипт для получения команд
./setup_yandex_routes_manual.sh

# Выполните команду одной строкой (замените на полученную команду)
sudo bash -c "ip route add 87.250.251.121 via 192.168.1.1 dev enp0s3; ip route add 87.250.250.242 via 192.168.1.1 dev enp0s3; ..."
```

### Вариант 2: Автоматическая настройка

```bash
# Запустите автоматический скрипт
sudo ./setup_yandex_routes.sh
```

### Вариант 3: Установка постоянного сервиса

```bash
# Установить сервис
sudo ./install_yandex_routes.sh install

# Проверить статус
sudo ./install_yandex_routes.sh status

# Протестировать подключение
sudo ./install_yandex_routes.sh test
```

## Проверка настройки

После настройки выполните:

```bash
# Проверить маршруты
ip route | grep -E "(87\.250\.|5\.45\.207|77\.88\.8|93\.158\.134|95\.108\.128|178\.154\.128)"

# Протестировать подключение
ping -c 3 api.tracker.yandex.net

# Проверить маршрут
traceroute api.tracker.yandex.net
```

## Управление сервисом

```bash
# Запустить маршруты
sudo ./install_yandex_routes.sh start

# Остановить маршруты
sudo ./install_yandex_routes.sh stop

# Удалить сервис
sudo ./install_yandex_routes.sh uninstall
```

## Настраиваемые IP-адреса

Скрипт настраивает маршруты для следующих сервисов:

### Yandex Tracker API
- `87.250.251.121` - api.tracker.yandex.net
- `87.250.250.242` - api.b.tracker.yandex.net
- `93.158.134.211` - tracker.yandex.ru

### Диапазоны IP Яндекса
- `5.45.207.0/24` - Диапазон IP Яндекса
- `77.88.8.0/24` - Диапазон IP Яндекса
- `87.250.224.0/19` - Диапазон IP Яндекса
- `93.158.134.0/24` - Диапазон IP Яндекса
- `95.108.128.0/17` - Диапазон IP Яндекса
- `178.154.128.0/17` - Диапазон IP Яндекса

### Google APIs (для Google Sheets интеграции)
- `142.251.36.202` - www.googleapis.com
- `142.251.36.234` - www.googleapis.com
- `142.251.37.10` - www.googleapis.com
- `142.251.36.170` - www.googleapis.com
- `142.250.0.0/16` - Диапазон Google APIs
- `172.217.0.0/16` - Диапазон Google APIs
- `74.125.0.0/16` - Диапазон Google APIs

## Устранение неполадок

### Маршруты не применяются

1. Проверьте, что у вас есть права root
2. Убедитесь, что основной шлюз определен правильно
3. Проверьте, что интерфейс существует

### VPN все еще используется

1. Проверьте порядок маршрутов: `ip route show`
2. Убедитесь, что маршруты к Яндексу имеют более высокий приоритет
3. Перезапустите VPN после настройки маршрутов

### Маршруты сбрасываются после перезагрузки

1. Используйте systemd сервис: `sudo ./install_yandex_routes.sh install`
2. Или добавьте команды в `/etc/rc.local`

## Примечания

- Маршруты действуют только до перезагрузки системы (если не установлен systemd сервис)
- При изменении конфигурации сети может потребоваться перенастройка
- Скрипт автоматически определяет основной шлюз и интерфейс
